code_name: 'GAMESS'
docker:
  image_name: 'mdi/gamess'


  build_image:
    # Install dependencies
    - apt-get update
    - apt-get install -y rsync csh

    - apt-get install -y patch wget nano make gcc gfortran
    - pip install jinja2

  build_engine:
    # Copy GAMESS source files into the build directory
    - mkdir -p build
    - rsync -a source/gamess build
    - cd build/gamess

    # Prepare install.info
    - export GCC_MAJOR_VERSION=`gcc --version | grep ^gcc | sed 's/gcc (.*) //g' | grep -o '[0-9]\{1,3\}\.[0-9]\{0,3\}\.[0-9]\{0,3\}' | cut -d '.' -f 1`
    - export GCC_MINOR_VERSION=`gcc --version | grep ^gcc | sed 's/gcc (.*) //g' | grep -o '[0-9]\{1,3\}\.[0-9]\{0,3\}\.[0-9]\{0,3\}' | cut -d '.' -f 2`
    - export NUM_CPU_CORES=`grep -c ^processor /proc/cpuinfo`
    - python bin/create-install-info.py --fortran_version ${GCC_MAJOR_VERSION}.${GCC_MINOR_VERSION}

    # Generate Makefile
    - export builddir=$(pwd)
    - echo "GMS_PATH = ${builddir}" > Makefile
    - echo "GMS_VERSION = 00" >> Makefile
    - echo "GMS_BUILD_PATH = ${builddir}" >> Makefile
    - echo 'include $(GMS_PATH)/Makefile.in' >> Makefile

    # Build GAMESS
    - make -j $NUM_CPU_CORES

    # Fix GAMESS run script
    - sed -i 's/set SCR=\/scr1\/$USER/set SCR=\/repo\/tests\/scratch/g' /repo/build/gamess/rungms
    - sed -i 's/set USERSCR=~\/gamess-devv/set USERSCR=\/repo\/tests\/scratch\/userscr/g' /repo/build/gamess/rungms
    - sed -i 's/set GMSPATH=~\/gamess-devv/set GMSPATH=\/repo\/build\/gamess/g' /repo/build/gamess/rungms

  validate_engine:
    - echo "Insert code that will confirm that your code has been built successfully"
    - export USER=MDIMECHANIC
    - rm -r tests/scratch
    - mkdir -p tests/scratch
    - mkdir -p tests/scratch/userscr

    # These files are created to ensure that the rungms script doesn't return a non-zero exit code
    - cd tests/scratch
    - touch TEST-mdi.cube
    - touch TEST-mdi.grd
    - touch TEST-mdi.csv
    - cd ../../

    - cd tests/validate_engine
    - csh -e ../../build/gamess/rungms TEST.inp 00 1 > TEST.log 2> TEST.err


engine_tests:
  # Provide at least one example input that can be used to test your code's MDI functionality
  - script:
      - echo "Insert commands to run an example calculation here"
